<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Chat</title>
  <link rel="stylesheet" href="/static/styles.css">

</head>
<body>
    <div class="app-container">

      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h3>Chats</h3>
          <button class="close-btn" onclick="toggleSidebar()">✕</button>
        </div>

        <div class="start-chat">
          <input id="otherUsername" placeholder="Username">
          <button onclick="startChat()">Start</button>
        </div>

        <div id="chatList"></div>
      </div>

      <div class="chat-area">
        <div class="chat-header">
          <button class="menu-btn" onclick="toggleSidebar()">☰</button>
          <span id="currentChatLabel">Select chat</span>
          <span id="currentUser" style="margin-left:auto;"></span>
          <button onclick="logout()">Logout</button>
        </div>

        <div id="messages"></div>

        <div class="chat-input">
          <input id="msg" placeholder="Type message...">
          <button onclick="send()">Send</button>
        </div>
      </div>

    </div>

  <script>
    let ws = null;
    let activeChatId = null;

    // Проверка авторизации при загрузке
    window.onload = () => {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "/static/login.html";
        return;
      }
      loadCurrentUser();
      loadChats();
    };


    function connectToChat(chatId) {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("currentChatLabel").innerText = `Chat #${chatId}`;
        activeChatId = chatId;
        highlightActiveChat();
      const token = localStorage.getItem("token");

      if (ws) {
        ws.close();
      }

      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}/ws/chats/${chatId}?token=${token}`);

      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        const div = document.getElementById("messages");
        div.innerHTML += `
          <div class="message">
            <b>${data.sender}:</b> ${data.content}
          </div>
        `;
        div.scrollTop = div.scrollHeight;
      };

      ws.onopen = () => {
        console.log("Connected to chat", chatId);
      };

      ws.onclose = () => {
        console.log("Disconnected");
      };
    }

    async function startChat() {
      const token = localStorage.getItem("token");
      const username = document.getElementById("otherUsername").value;

      if (!username) {
        alert("Enter username");
        return;
      }

      const res = await fetch(`/chats/by-username/${username}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!res.ok) {
        alert("User not found or error");
        return;
      }

      const data = await res.json();
      connectToChat(data.id);
      loadChats();
    }

    function send() {
      if (!ws) {
        alert("Not connected to any chat");
        return;
      }

      const text = document.getElementById("msg").value.trim();
      if (!text) return;

      ws.send(JSON.stringify({ content: text }));
      document.getElementById("msg").value = "";
    }

    function logout() {
      localStorage.removeItem("token");
      if (ws) {
        ws.close();
      }
      window.location.href = "/static/login.html";
    }

    async function loadCurrentUser() {
      const token = localStorage.getItem("token");

      const res = await fetch("/users/me", {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (res.ok) {
        const user = await res.json();
        document.getElementById("currentUser").innerText = `@${user.username} (you)`;
      }
    }


    async function loadChats() {
      const token = localStorage.getItem("token");

      const res = await fetch("/chats/my", {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!res.ok) return;

      const chats = await res.json();
      const list = document.getElementById("chatList");
      list.innerHTML = "";

      for (const chat of chats) {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.dataset.chatId = chat.id;
        div.innerHTML = `
          <span>${chat.other_username || "Unknown"}</span>
          <span class="chat-actions" onclick="openChatMenu(event, ${chat.id})">⋯</span>
        `;
        div.onclick = () => connectToChat(chat.id);
        list.appendChild(div);
        highlightActiveChat();
      }
    }


    function highlightActiveChat() {
      const items = document.querySelectorAll(".chat-item");
      items.forEach(item => {
        if (parseInt(item.dataset.chatId) === activeChatId) {
          item.classList.add("active-chat");
        } else {
          item.classList.remove("active-chat");
        }
      });
    }

    function openChatMenu(event, chatId) {
      event.stopPropagation(); // чтобы не открывался чат

      closeChatMenu();

      const menu = document.createElement("div");
      menu.className = "chat-menu";
      menu.innerHTML = `
        <div class="chat-menu-item" onclick="leaveChat(${chatId})">
          Leave chat
        </div>
      `;

      document.body.appendChild(menu);

      const rect = event.target.getBoundingClientRect();
      menu.style.top = rect.bottom + "px";
      menu.style.left = rect.left + "px";

      document.addEventListener("click", closeChatMenu);
    }


    function closeChatMenu() {
      const menu = document.querySelector(".chat-menu");
      if (menu) menu.remove();
      document.removeEventListener("click", closeChatMenu);
    }


    async function leaveChat(chatId) {
      const token = localStorage.getItem("token");

      const res = await fetch(`/chats/${chatId}/leave`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!res.ok) {
        alert("Failed to leave chat");
        return;
      }

      // если мы были в этом чате — закрываем WS
      if (activeChatId === chatId) {
        activeChatId = null;
        if (ws) {
          ws.close();
          ws = null;
        }
        document.getElementById("messages").innerHTML = "";
      }

      loadChats();
    }


    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("open");
    }


    function adjustForKeyboard() {
      if (!window.visualViewport) return;

      const viewport = window.visualViewport;
      const chatInput = document.querySelector(".chat-input");

      function update() {
        const keyboardHeight = window.innerHeight - viewport.height - viewport.offsetTop;

        if (keyboardHeight > 0) {
          chatInput.style.transform = `translateY(-${keyboardHeight}px)`;
        } else {
          chatInput.style.transform = "";
        }
      }

      viewport.addEventListener("resize", update);
      viewport.addEventListener("scroll", update);
    }

    adjustForKeyboard();
  </script>
</body>
</html>
